version: 2.1
executors:
  docker-builder:
    docker:
      - image: circleci/openjdk:11-jdk
  docker-azure:
    docker:
      - image: microsoft/azure-cli

jobs:
  build-software:
    # Build the application
    executor: docker-builder
    working_directory: ~/repo
    environment:
      MAVEN_OPTS: -Xmx1024m
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            - v1-dependencies-
      - run:
          name: Build dependency list
          command: mvn -B install -DskipTests dependency:go-offline
      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}
      - run:
          name: Build software
          command: mvn -B clean package javadoc:javadoc javadoc:aggregate
      - persist_to_workspace:
          root: ~/repo
          paths:
            - target
            - ./*/target
      - run:
          name: Preparing test reports
          command: mkdir -p target/junit/ && find . -type f -regex ".*/target/.*-reports/.*xml" -exec cp {} target/junit/ \;
      - store_test_results:
          path: target/junit/

  publish-coverage:
    executor: docker-builder
    working_directory: ~/repo
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Report code coverage
          command: mvn -B -Pcoveralls -DrepoKey=$coverageKey

  publish-sonar:
    executor: docker-builder
    working_directory: ~/repo
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Performing analysis
          command: mvn -B -Psonar -Dsonar.login=$sonarKey

  publish-javadoc:
    executor: docker-azure
    working_directory: ~/repo
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Publishing documentation Azure
          command: |
            az storage blob upload-batch \
                --source ~/repo/target/site/apidocs \
                --destination $azureBlob \
                --destination-path java/language/snapshot \
                --connection-string $azureDocString

  release-dryrun:
    # verify that the software is release-able on the master branch
    executor: docker-builder
    working_directory: ~/repo
    environment:
      MAVEN_OPTS: -Xmx1024m
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
      - run:
          name: Performing a dry run release
          command: mvn -B release:prepare -DdryRun=true -P release-profile -s settings.xml

  release:
    executor: docker-builder
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
      - run:
          name: Setup the PGP key
          command: |
            openssl aes-256-cbc -pass pass:$openSslPwd -in private-key.gpg.enc -out private-key.gpg -d
            gpg --import private-key.gpg
      - run:
          name: Obtain release version
          command: |
            export rawV=`mvn org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -Dexpression=project.version -q -DforceStdout`
            echo "${rawV//[A-Z\-]/}" > target/version.file
      - run:
          name: Perform release
          command: mvn -V -B -s settings.xml -P release-profile release:prepare release:perform
      - persist_to_workspace:
          root: ~/repo
          paths:
            - target
            - promo-site

  release-javadoc:
    executor: docker-azure
    working_directory: ~/repo
    steps:
      - attach_workspace:
          at: ~/repo
      - run:
          name: Determine version
          command: export releaseVersion=`cat ~/repo/target/version.file`
      - run:
          name: Publish promo site
          command: |
            az storage blob upload-batch \
                --source ~/repo/promo-site \
                --destination $azureBlob \
                --destination-path project/language-extension \
                --connection-string $azureDocString
      - run:
          name: Publishing JavaDoc Azure
          command: |
            az storage blob upload-batch \
                --source ~/repo/target/site/apidocs \
                --destination $azureBlob \
                --destination-path java/language/$releaseVersion \
                --connection-string $azureDocString

workflows:
  version: 2
  commit-build:
    jobs:
      - build-software:
          filters:
            branches:
              ignore: ^release/.*
      - publish-coverage:
          requires:
            - build-software
      - publish-javadoc:
          requires:
            - build-software
          filters:
            branches:
              only: master
      - publish-sonar:
          requires:
            - build-software
          filters:
            branches:
              only: master
  release-dry-run:
    triggers:
      - schedule:
          cron: "0 0 * * 1"
          filters:
            branches:
              only: master
    jobs:
      - release-dryrun
  release-build:
    jobs:
      - release:
          filters:
            branches:
              only: ^release/.*
      - release-javadoc:
          requires:
            - release
          filters:
            branches:
              only: ^release/.*
